

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>入力式学習アプリ</title>
    <style>
        :root {
            --primary-color: #28a745; 
            --secondary-color: #007bff;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --border-radius: 12px;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            background-color: var(--light-gray); margin: 0; padding: 20px; box-sizing: border-box;
        }
        #app-container, #setup-container, #completion-container {
            width: 100%; max-width: 700px; text-align: center; background-color: white;
            padding: 2rem; border-radius: var(--border-radius); box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        #app-container, #completion-container { display: none; }
        .hidden { display: none; }
        h1, h2 { color: var(--dark-gray); }
        #question-area { min-height: 150px; margin-bottom: 1.5rem; }
        #question-number { font-size: 1.2rem; font-weight: bold; color: var(--secondary-color); margin-bottom: 1rem; }
        #question-text { font-size: 1.5rem; color: var(--dark-gray); white-space: pre-wrap; text-align: left; }
        #answer-input-area { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
        .answer-input { 
            width: 90%; padding: 0.8rem; font-size: 1.2rem; border-radius: var(--border-radius); 
            border: 2px solid #ccc; transition: border-color 0.3s; margin: 0 auto;
        }
        .answer-input:focus { outline: none; border-color: var(--secondary-color); }
        .answer-input.is-incorrect { border-color: var(--danger-color); }
        #controls, #completion-controls { display: flex; justify-content: center; gap: 1rem; margin-top: 2rem; }
        button { 
            padding: 0.8rem 1.5rem; font-size: 1rem; font-weight: bold; color: white; 
            border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.3s, transform 0.1s;
        }
        #check-btn { background-color: var(--primary-color); }
        #check-btn:hover { background-color: #218838; }
        #show-answer-btn { background-color: var(--secondary-color); display: none; }
        #show-answer-btn:hover { background-color: #0056b3; }
        #next-btn { background-color: var(--secondary-color); }
        #next-btn:hover { background-color: #0056b3; }
        #result-area { min-height: 50px; font-size: 1.5rem; font-weight: bold; }
        .correct { color: var(--primary-color); }
        .incorrect { color: var(--danger-color); }
        #correct-answer-display { font-size: 1.2rem; color: var(--dark-gray); margin-top: 0.5rem; visibility: hidden; white-space: pre-wrap; }
        #progress { font-size: 1.2rem; color: #6c757d; margin-top: 1rem; }
        /* Setup & Completion Screen */
        #setup-container h2, #completion-container h1 { margin-top: 0; }
        .options { margin: 2rem 0; text-align: left; display: inline-block; }
        .options label { font-size: 1.2rem; display: block; margin-bottom: 0.5rem; cursor: pointer; }
        #start-btn, #retry-btn { background-color: #28a745; }
        #start-btn:hover, #retry-btn:hover { background-color: #218838; }
        #select-file-btn { background-color: var(--secondary-color); }
        #select-file-btn:hover { background-color: #0056b3; }
        #retry-incorrect-btn { background-color: var(--warning-color); color: var(--dark-gray); }
        #retry-incorrect-btn:hover { background-color: #e0a800; }
        /* Results */
        #results-summary { margin: 2rem 0; font-size: 1.5rem; }
        #results-score { font-size: 2.5rem; font-weight: bold; color: var(--primary-color); }
        #results-list-container { margin-top: 2rem; text-align: left; }
        #results-list-container h2 { font-size: 1.5rem; }
        .result-item { padding: 1rem; margin-bottom: 1rem; border-radius: 8px; }
        .result-item.is-correct { background-color: #f0fff4; border-left: 5px solid var(--primary-color); }
        .result-item.is-incorrect { background-color: #fff3f3; border-left: 5px solid var(--danger-color); }
        .result-item.is-corrected { background-color: #fff8e1; border-left: 5px solid var(--warning-color); }
        .result-item-q { font-weight: bold; }
        .result-item-a { display: none; margin-top: 0.5rem; }
        .result-item.is-incorrect .result-item-a { color: var(--primary-color); }
        .result-item:hover { cursor: pointer; filter: brightness(95%); }

        /* Responsive Design for Mobile */
        @media (max-width: 600px) {
            body { padding: 10px; }
            #app-container, #setup-container, #completion-container { padding: 1rem; }
            #question-area { min-height: 100px; }
            #question-text { font-size: 1.2rem; }
            .answer-input { font-size: 1rem; }
            h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

<div id="setup-container">
    <h2>学習アプリ設定</h2>
    <div class="options">
        <button id="select-file-btn">問題ファイルを選択</button>
        <input type="file" id="file-selector" accept=".json" style="display: none;">
    </div>
    <div class="options">
        <label>
            <input type="checkbox" id="random-mode-checkbox">
            ランダムモードで出題する
        </label>
    </div>
    <div>
        <button id="start-btn">学習を始める</button>
    </div>
</div>

<div id="app-container">
    <h1>入力式学習アプリ</h1>
    <div id="question-area">
        <div id="question-number"></div>
        <div id="question-text"></div>
    </div>
    <div id="answer-input-area"></div>
    <div id="controls">
        <button id="check-btn">こたえ合わせ</button>
        <button id="show-answer-btn">答えを見る</button>
        <button id="next-btn">次の問題</button>
    </div>
    <div id="result-area">
        <span id="result-message"></span>
        <div id="correct-answer-display"></div>
    </div>
    <div id="progress"></div>
</div>

<div id="completion-container">
    <h1>学習結果</h1>
    <div id="results-summary">
        <span id="correct-count">0</span> / <span id="total-questions">0</span> 問正解
        <div id="results-score">0%</div>
    </div>
    <div id="results-list-container">
        <h2>全問題の結果</h2>
        <div id="results-list"></div>
    </div>
    <div id="completion-controls">
        <button id="retry-btn">もう一度挑戦する</button>
        <button id="retry-incorrect-btn">間違えた問題だけ再挑戦</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const elements = {
            setupContainer: document.getElementById('setup-container'),
            appContainer: document.getElementById('app-container'),
            completionContainer: document.getElementById('completion-container'),
            startBtn: document.getElementById('start-btn'),
            retryBtn: document.getElementById('retry-btn'),
            retryIncorrectBtn: document.getElementById('retry-incorrect-btn'),
            randomModeCheckbox: document.getElementById('random-mode-checkbox'),
            questionNumber: document.getElementById('question-number'),
            questionText: document.getElementById('question-text'),
            answerInputArea: document.getElementById('answer-input-area'),
            checkBtn: document.getElementById('check-btn'),
            showAnswerBtn: document.getElementById('show-answer-btn'),
            nextBtn: document.getElementById('next-btn'),
            resultMessage: document.getElementById('result-message'),
            correctAnswerDisplay: document.getElementById('correct-answer-display'),
            progress: document.getElementById('progress'),
            correctCount: document.getElementById('correct-count'),
            totalQuestions: document.getElementById('total-questions'),
            resultsScore: document.getElementById('results-score'),
            resultsList: document.getElementById('results-list'),
            selectFileBtn: document.getElementById('select-file-btn'),
            fileSelector: document.getElementById('file-selector'),
        };

        let originalQuestionsData = [];
        let questionsData = [];
        let currentIndex = 0;
        let questionsToRetry = new Set(); // Used for "retry incorrect questions" button
        let finalIncorrectForScore = new Set(); // Used for score calculation
        let questionStatusMap = new Map(); // Stores status for results display: 'correct', 'incorrect', 'corrected', 'shown_answer'
        let lastUsedFileName = 'mondai.json'; // Stores the name of the last successfully loaded file
        let currentLoadedFile = null; // To store the File object if loaded from user selection in the current setup session

        function groupQuestions(data) {
            const grouped = new Map();
            data.forEach(item => {
                const baseNumber = item.number.split('.')[0];
                if (!grouped.has(baseNumber)) {
                    grouped.set(baseNumber, { number: baseNumber, questions: [], answers: [] });
                }
                const entry = grouped.get(baseNumber);
                entry.questions.push(item.question);
                entry.answers.push(item.answer);
            });
            return Array.from(grouped.values());
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

                

        async function loadOriginalData(fileOrName = null) {
            let rawData;
            let fileNameToLoad = 'mondai.json'; // Default to mondai.json

            if (fileOrName instanceof File) {
                // User selected a file via input type="file"
                try {
                    const reader = new FileReader();
                    rawData = await new Promise((resolve, reject) => {
                        reader.onload = (e) => resolve(JSON.parse(e.target.result));
                        reader.onerror = (e) => reject(e);
                        reader.readAsText(fileOrName);
                    });
                    lastUsedFileName = fileOrName.name; // Update last used file name
                } catch (error) {
                    console.error("Could not load questions from selected file:", error);
                    alert(`選択されたファイルの読み込みに失敗しました。ファイルを確認してください。`);
                    return false;
                }
            } else if (typeof fileOrName === 'string') {
                // Load by file name (e.g., from lastUsedFileName)
                fileNameToLoad = fileOrName;
                try {
                    const response = await fetch(fileNameToLoad);
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    rawData = await response.json();
                    lastUsedFileName = fileNameToLoad; // Update last used file name
                } catch (error) {
                    console.error("Could not load questions from " + fileNameToLoad + ":", error);
                    alert(`問題の読み込みに失敗しました。ファイル「${fileNameToLoad}」を確認してください。`);
                    return false;
                }
            } else {
                // No specific file/name provided, use lastUsedFileName or default
                fileNameToLoad = lastUsedFileName || 'mondai.json';
                try {
                    const response = await fetch(fileNameToLoad);
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    rawData = await response.json();
                    lastUsedFileName = fileNameToLoad; // Update last used file name
                } catch (error) {
                    console.error("Could not load questions from " + fileNameToLoad + ":", error);
                    alert(`問題の読み込みに失敗しました。ファイル「${fileNameToLoad}」を確認してください。`);
                    return false;
                }
            }
            originalQuestionsData = groupQuestions(rawData);
            return true;
        }

        async function startSession(questionSet) {
            questionsData = [...questionSet];
            if (elements.randomModeCheckbox.checked && questionSet === originalQuestionsData) {
                shuffleArray(questionsData);
            }

            if (questionsData.length > 0) {
                questionsToRetry.clear();
                finalIncorrectForScore.clear();
                questionStatusMap.clear(); // Clear status for new session
                currentIndex = 0;
                elements.setupContainer.style.display = 'none';
                elements.completionContainer.style.display = 'none';
                elements.appContainer.style.display = 'block';
                displayQuestion(currentIndex);
            } else {
                alert("対象の問題がありません。");
                elements.setupContainer.style.display = 'block';
            }
        }

        function displayQuestion(index) {
            const question = questionsData[index];
            elements.questionNumber.textContent = `問題 ${question.number}`;
            
            const markers = ['①', '②', '③', '④', '⑤', '⑥', '⑦', '⑧', '⑨', '⑩'];
            if (question.questions.length > 1) {
                elements.questionText.textContent = question.questions.map((q, i) => `${markers[i]} ${q}`).join('\n');
            } else {
                elements.questionText.textContent = question.questions[0];
            }

            elements.answerInputArea.innerHTML = '';
            question.answers.forEach((ans, i) => {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'answer-input';
                input.placeholder = question.questions.length > 1 ? `${markers[i]}の答え` : '答えを入力';
                elements.answerInputArea.appendChild(input);
            });

            elements.progress.textContent = `${index + 1} / ${questionsData.length}`;
            resetState();
        }

        function resetState() {
            document.querySelectorAll('.answer-input').forEach(input => {
                input.disabled = false;
                input.classList.remove('is-incorrect');
            });
            elements.resultMessage.textContent = '';
            elements.correctAnswerDisplay.style.visibility = 'hidden';
            elements.checkBtn.style.display = 'inline-block';
            elements.showAnswerBtn.style.display = 'none';
            elements.nextBtn.style.display = 'none';
            const firstInput = elements.answerInputArea.querySelector('.answer-input');
            if(firstInput) firstInput.focus();
        }

        function normalize(str) {
            if (typeof str !== 'string') return '';
            return str.normalize('NFKC').toLowerCase().replace(/[\s\p{P}]/gu, '');
        }

        function checkAnswer() {
            const currentQuestion = questionsData[currentIndex];
            const userInputs = Array.from(document.querySelectorAll('.answer-input'));
            const correctAnswers = currentQuestion.answers;
            let allCorrect = true;

            userInputs.forEach((input, i) => {
                const userAnswer = normalize(input.value);
                const correctAnswer = normalize(correctAnswers[i]);
                if (userAnswer !== correctAnswer) {
                    allCorrect = false;
                    input.classList.add('is-incorrect');
                } else {
                    input.classList.remove('is-incorrect');
                }
            });

            if (allCorrect) {
                elements.resultMessage.textContent = '正解！';
                elements.resultMessage.className = 'correct';
                userInputs.forEach(input => input.disabled = true);
                elements.checkBtn.style.display = 'none';
                elements.nextBtn.style.display = 'inline-block';
                elements.nextBtn.focus();

                elements.nextBtn.focus();

                if (questionsToRetry.has(currentQuestion)) {
                    questionStatusMap.set(currentQuestion, 'corrected');
                    // questionsToRetry.delete(currentQuestion); // この行を削除またはコメントアウト
                } else {
                    questionStatusMap.set(currentQuestion, 'correct');
                }
                finalIncorrectForScore.delete(currentQuestion); // Always remove from final incorrect if now correct
            } else {
                elements.resultMessage.textContent = '不正解';
                elements.resultMessage.className = 'incorrect';
                elements.showAnswerBtn.style.display = 'inline-block';
                questionsToRetry.add(currentQuestion);
                finalIncorrectForScore.add(currentQuestion);
                questionStatusMap.set(currentQuestion, 'incorrect');
            }
        }

        function showResults() {
            const total = questionsData.length;
            const correctCount = total - finalIncorrectForScore.size;
            const score = total > 0 ? Math.round((correctCount / total) * 100) : 0;

            elements.correctCount.textContent = correctCount;
            elements.totalQuestions.textContent = total;
            elements.resultsScore.textContent = `${score}%`;

            elements.resultsList.innerHTML = '';
            questionsData.forEach(q => {
                const status = questionStatusMap.get(q) || 'correct'; // Default to correct if not explicitly set
                const item = document.createElement('div');
                item.className = `result-item`;

                // Apply class based on status
                if (status === 'incorrect' || status === 'shown_answer') {
                    item.classList.add('is-incorrect');
                } else if (status === 'corrected') {
                    item.classList.add('is-corrected'); // New class for corrected
                } else {
                    item.classList.add('is-correct');
                }
                                
                const markers = ['①', '②', '③', '④', '⑤', '⑥', '⑦', '⑧', '⑨', '⑩'];
                const qText = q.questions.length > 1 ? q.questions.map((text, i) => `${markers[i]} ${text}`).join('\n') : q.questions[0];
                const aText = q.answers.length > 1 ? q.answers.map((text, i) => `${markers[i]} ${text}`).join('\n') : q.answers[0];

                item.innerHTML = `<div class="result-item-q">Q${q.number}: ${qText}</div><div class="result-item-a">A: ${aText}</div>`;
                item.addEventListener('click', () => {
                    const answerDiv = item.querySelector('.result-item-a');
                    answerDiv.style.display = answerDiv.style.display === 'none' ? 'block' : 'none';
                });
                elements.resultsList.appendChild(item);
            });

            if (questionsToRetry.size > 0) {
                elements.retryIncorrectBtn.style.display = 'inline-block';
            } else {
                elements.retryIncorrectBtn.style.display = 'none';
            }

            elements.appContainer.style.display = 'none';
            elements.completionContainer.style.display = 'block';
        }

        elements.checkBtn.addEventListener('click', checkAnswer);
        elements.answerInputArea.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && elements.checkBtn.style.display === 'inline-block') {
                e.preventDefault();
                checkAnswer();
            }
        });

        elements.showAnswerBtn.addEventListener('click', () => {
            const currentQuestion = questionsData[currentIndex];
            const correctAnswers = currentQuestion.answers;
            const markers = ['①', '②', '③', '④', '⑤', '⑥', '⑦', '⑧', '⑨', '⑩'];
            const answerText = correctAnswers.map((ans, i) => `${markers[i]} ${ans}`).join('\n');

            elements.correctAnswerDisplay.textContent = `正解:\n${answerText}`;
            elements.correctAnswerDisplay.style.visibility = 'visible';
            elements.checkBtn.style.display = 'none';
            elements.showAnswerBtn.style.display = 'none';
            elements.nextBtn.style.display = 'inline-block';

            questionStatusMap.set(currentQuestion, 'shown_answer');
            questionsToRetry.add(currentQuestion); // Ensure it's marked for retry
            finalIncorrectForScore.add(currentQuestion); // Ensure it affects score if answer was shown
        });

        elements.nextBtn.addEventListener('click', () => {
            if (currentIndex < questionsData.length - 1) {
                currentIndex++;
                displayQuestion(currentIndex);
            } else {
                showResults();
            }
        });

        elements.startBtn.addEventListener('click', async () => {
            const success = await loadOriginalData(currentLoadedFile || lastUsedFileName);
            if (success) {
                startSession(originalQuestionsData);
            }
        });

        elements.selectFileBtn.addEventListener('click', () => {
            elements.fileSelector.click();
        });

        elements.fileSelector.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                currentLoadedFile = file;
                alert(`ファイル「${file.name}」が選択されました。`);
            }
        });

        elements.retryBtn.addEventListener('click', () => {
            elements.completionContainer.style.display = 'none';
            elements.setupContainer.style.display = 'block';
            currentLoadedFile = null; // Reset selected file for next session
        });

        elements.retryIncorrectBtn.addEventListener('click', () => {
            startSession(Array.from(questionsToRetry));
        });
    });
</script>

</body>
</html>
